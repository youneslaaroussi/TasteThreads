@startuml TasteThreadsOrchestrator
skinparam dpi 300
skinparam backgroundColor #FFFFFF
skinparam defaultFontName Arial
skinparam defaultFontSize 11
skinparam defaultFontColor #232F3E
skinparam roundcorner 4
skinparam shadowing false
skinparam linetype ortho

skinparam component {
  BackgroundColor #146EB4
  BorderColor #0F4C75
  BorderThickness 2
  FontSize 10
  FontStyle bold
  FontColor #FFFFFF
  Padding 8
}

skinparam database {
  BackgroundColor #F58536
  BorderColor #D2691E
  BorderThickness 2
  FontSize 10
  FontStyle bold
  FontColor #FFFFFF
  Padding 8
}

skinparam package {
  BackgroundColor #E8F4F8
  BorderColor #146EB4
  BorderThickness 2
  FontSize 12
  FontStyle bold
  FontColor #146EB4
  Padding 15
}

skinparam arrow {
  Thickness 2
  Color #232F3E
  FontSize 12
}

skinparam nodesep 60
skinparam ranksep 80
skinparam packagePadding 15

package "Clients" #E8F4F8 {
  component "iOS Chat UI\nSwiftUI + Combine" as ios_chat
  component "MapKit Canvas\nItinerary Overlay" as mapkit
  component "Reservation Cards\nAction Buttons" as reservation_cards
  ios_chat -[hidden]- mapkit
  mapkit -[hidden]- reservation_cards
}

package "Application Layer" #E8F4F8 {
  component "Rooms Router\nREST + WebSocket" as rooms_router
  component "SSE Streamer\nPartial Tokens" as sse_stream
  component "Tess Orchestrator\nGPT-4o-mini + Pydantic AI" as orchestrator
  component "Agent Dependencies\nchat_id · user prefs" as deps
  database "Redis Pub/Sub\nFan-out" as redis_pubsub
  database "PostgreSQL\nRooms · Itinerary · Chat" as postgres
  component "Logfire\nTraces + Metrics" as logfire
  rooms_router -[hidden]- sse_stream
  orchestrator -[hidden]- deps
  redis_pubsub -[hidden]- postgres
}

package "External Services" #E8F4F8 {
  component "Yelp AI Chat API\n/ai/chat/v2" as ai_chat
  component "Yelp Reservations API\nOpenings · Holds · Book" as reservations
  component "Yelp Fusion API\nBusiness Details" as fusion
  ai_chat -[hidden]- reservations
  reservations -[hidden]- fusion
}

' Client flows
ios_chat --> rooms_router : Messages
rooms_router --> redis_pubsub : Publish
redis_pubsub ..> ios_chat : Broadcast
rooms_router --> postgres : Persist

' Orchestration flows
rooms_router --> orchestrator : NL Request
postgres ..> deps : Chat ID
deps --> orchestrator : Context
orchestrator --> sse_stream : Token Stream
sse_stream --> ios_chat : SSE Updates

' Yelp API flows
orchestrator --> ai_chat : Discovery
ai_chat --> orchestrator : Results
orchestrator --> reservations : Bookings
reservations --> orchestrator : Confirmations
orchestrator ..> fusion : Enrichment
fusion ..> orchestrator : Metadata

' Response flows
orchestrator --> reservation_cards : Cards
reservation_cards ..> rooms_router : Selection
rooms_router --> reservations : Hold · Book
mapkit ..> ios_chat : State
postgres ..> mapkit : Itinerary

' Observability
orchestrator --> logfire : Traces

@enduml
